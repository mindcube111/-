# Cloudflare Pages éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡æ¸…å•

### 1. å¿…éœ€å·¥å…·
- [ ] Node.js 18+ å·²å®‰è£…
- [ ] Wrangler CLI å·²å®‰è£…ï¼š`npm install -g wrangler`
- [ ] Cloudflare è´¦å·å·²æ³¨å†Œ
- [ ] åŸŸåå·²æ¥å…¥ Cloudflareï¼ˆNS å·²åˆ‡æ¢ï¼‰

### 2. ç™»å½• Cloudflare
```bash
wrangler login
```
è¿™ä¼šæ‰“å¼€æµè§ˆå™¨ï¼Œå®Œæˆç™»å½•æˆæƒã€‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»º KV å‘½åç©ºé—´

1. **é€šè¿‡ Dashboard åˆ›å»ºï¼ˆæ¨èï¼‰**
   - è®¿é—®ï¼šhttps://dash.cloudflare.com
   - è¿›å…¥ï¼šWorkers & Pages â†’ KV â†’ Create a namespace
   - å‘½åï¼š`æˆ‘`
   - è®°å½•ä¸‹æ˜¾ç¤ºçš„ **Namespace ID**

2. **æˆ–é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º**
   ```bash
   wrangler kv:namespace create "INVITE_CODES"
   ```
   è®°å½•è¿”å›çš„ `id` å€¼ã€‚

### æ­¥éª¤ 2: å‡†å¤‡é‚€è¯·ç æ–‡ä»¶

1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `invites.txt`ï¼ˆ**ä¸è¦æäº¤åˆ° Git**ï¼‰
   ```
   ABC123
   DEF456
   GHI789
   ...
   ```
   æ¯è¡Œä¸€ä¸ªé‚€è¯·ç ã€‚

2. ç”Ÿæˆéšæœºç›å€¼ï¼ˆç”¨äºå“ˆå¸Œé‚€è¯·ç ï¼‰
   ```bash
   # Windows PowerShell
   [Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
   
   # æˆ–ä½¿ç”¨åœ¨çº¿å·¥å…·ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
   ```
   è®°å½•è¿™ä¸ªç›å€¼ï¼Œç¨åéœ€è¦é…ç½®åˆ°ç¯å¢ƒå˜é‡ã€‚

### æ­¥éª¤ 3: ç”Ÿæˆ KV å¯¼å…¥æ–‡ä»¶

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆWindows PowerShellï¼‰
$env:INVITE_SALT="ä½ çš„éšæœºç›å€¼"

# ç”Ÿæˆ bulk.json
node tools/generate-bulk.js
```

è¿™ä¼šç”Ÿæˆ `bulk.json` æ–‡ä»¶ï¼ŒåŒ…å«å“ˆå¸Œåçš„é‚€è¯·ç æ•°æ®ã€‚

### æ­¥éª¤ 4: å¯¼å…¥é‚€è¯·ç åˆ° KV

```bash
# æŸ¥è¯¢å‘½åç©ºé—´ IDï¼ˆå¦‚æœå¿˜è®°äº†ï¼‰
wrangler kv:namespace list

# å¯¼å…¥é‚€è¯·ç ï¼ˆæ›¿æ¢ <NAMESPACE_ID> ä¸ºå®é™…çš„ IDï¼‰
wrangler kv:bulk put --namespace-id <NAMESPACE_ID> bulk.json

# éªŒè¯å¯¼å…¥ï¼ˆå¯é€‰ï¼‰
wrangler kv:key get --namespace-id <NAMESPACE_ID> <æŸä¸ªhashé”®>
```

### æ­¥éª¤ 5: åˆ›å»º Cloudflare Pages é¡¹ç›®

1. **é€šè¿‡ Dashboard åˆ›å»º**
   - è®¿é—®ï¼šhttps://dash.cloudflare.com
   - è¿›å…¥ï¼šWorkers & Pages â†’ Create application â†’ Pages â†’ Connect to Git
   - é€‰æ‹© GitHub å¹¶å®Œæˆæˆæƒ
   - é€‰æ‹©ä»“åº“ï¼š`mindcube111/-`ï¼ˆæˆ–ä½ çš„ä»“åº“ï¼‰
   - é¡¹ç›®åç§°ï¼š`stranger-things-test`
   - ç”Ÿäº§åˆ†æ”¯ï¼š`main`
   - æ„å»ºå‘½ä»¤ï¼šç•™ç©ºï¼ˆé™æ€ç«™ç‚¹ï¼‰
   - æ„å»ºè¾“å‡ºç›®å½•ï¼š`/`ï¼ˆæ ¹ç›®å½•ï¼‰
   - ç‚¹å‡» "Save and Deploy"

2. **æˆ–é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º**
   ```bash
   wrangler pages project create stranger-things-test
   ```

### æ­¥éª¤ 6: é…ç½®ç¯å¢ƒå˜é‡å’Œ KV ç»‘å®š

åœ¨ Cloudflare Dashboard ä¸­ï¼š

1. **è¿›å…¥é¡¹ç›®è®¾ç½®**
   - Pages â†’ stranger-things-test â†’ Settings

2. **é…ç½®ç¯å¢ƒå˜é‡**
   - Environment variables â†’ Add variable
   - æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š
     - `ADMIN_PASSWORD`: ä½ çš„ç®¡ç†å‘˜å¯†ç 
     - `INVITE_SALT`: æ­¥éª¤ 2 ç”Ÿæˆçš„éšæœºç›å€¼

3. **ç»‘å®š KV å‘½åç©ºé—´**
   - KV namespaces â†’ Add binding
   - Variable name: `INVITE_CODES`
   - KV namespace: é€‰æ‹©ä¹‹å‰åˆ›å»ºçš„ `INVITE_CODES`

### æ­¥éª¤ 7: éƒ¨ç½²ä»£ç 

#### æ–¹å¼ A: è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰
- æ¨é€ä»£ç åˆ° Git ä¸»åˆ†æ”¯
- Cloudflare Pages ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²

#### æ–¹å¼ B: æ‰‹åŠ¨éƒ¨ç½²
```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
wrangler pages deploy . --project-name=stranger-things-test
```

### æ­¥éª¤ 8: ç»‘å®šè‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰

1. åœ¨ Pages é¡¹ç›®è®¾ç½®ä¸­
2. Custom domains â†’ Set up a custom domain
3. è¾“å…¥ä½ çš„åŸŸå
4. æŒ‰ç…§æç¤ºé…ç½® DNS è®°å½•ï¼ˆé€šå¸¸æ˜¯ CNAMEï¼‰

---

## âœ… éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
è®¿é—®ä½ çš„ Pages URLï¼š`https://stranger-things-test.pages.dev`

### 2. æµ‹è¯•é‚€è¯·ç  API
```bash
# ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•
curl -X POST https://ä½ çš„åŸŸå/api/verify-invite \
  -H "Content-Type: application/json" \
  -d '{"code":"ABC123"}'

# é¢„æœŸå“åº”ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰ï¼š
# {"ok":true}

# å†æ¬¡ä½¿ç”¨ç›¸åŒé‚€è¯·ç ï¼š
# {"ok":false,"message":"used"}
```

### 3. æµ‹è¯•ç®¡ç†å‘˜ç™»å½• API
```bash
curl -X POST https://ä½ çš„åŸŸå/api/admin-login \
  -H "Content-Type: application/json" \
  -d '{"password":"ä½ çš„ç®¡ç†å‘˜å¯†ç "}'

# é¢„æœŸå“åº”ï¼š
# {"ok":true}
```

### 4. æ£€æŸ¥å‰ç«¯åŠŸèƒ½
- [ ] é¦–é¡µæ­£å¸¸åŠ è½½
- [ ] é‚€è¯·ç éªŒè¯åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•é¡µé¢æ­£å¸¸
- [ ] ç»“æœé¡µé¢æ­£å¸¸
- [ ] ç®¡ç†å‘˜é¡µé¢æ­£å¸¸

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. è®¾ç½®é€Ÿç‡é™åˆ¶
åœ¨ Cloudflare Dashboardï¼š
- Security â†’ WAF â†’ Rate limiting rules
- ä¸º `/api/verify-invite` è®¾ç½®é™æµï¼ˆå¦‚æ¯ IP æ¯åˆ†é’Ÿ 60 æ¬¡ï¼‰

### 2. ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶
ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶åœ¨ `.gitignore` ä¸­ï¼š
```
invites.txt
bulk.json
.env
*.log
```

### 3. å®šæœŸæ›´æ–°
- å®šæœŸæ›´æ¢ `INVITE_SALT`
- å®šæœŸæ›´æ–°ç®¡ç†å‘˜å¯†ç 
- ç›‘æ§ API ä½¿ç”¨æƒ…å†µ

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q: éƒ¨ç½²å Functions ä¸å·¥ä½œï¼Ÿ
A: æ£€æŸ¥ï¼š
- ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
- KV å‘½åç©ºé—´æ˜¯å¦æ­£ç¡®ç»‘å®š
- Functions æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆ`functions/api/*.js`ï¼‰

### Q: é‚€è¯·ç éªŒè¯å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥ï¼š
- `INVITE_SALT` æ˜¯å¦ä¸ç”Ÿæˆ bulk.json æ—¶ä½¿ç”¨çš„ç›¸åŒ
- KV ä¸­æ˜¯å¦å·²å¯¼å…¥é‚€è¯·ç 
- é‚€è¯·ç æ˜¯å¦å·²è¢«ä½¿ç”¨

### Q: å¦‚ä½•æ·»åŠ æ–°é‚€è¯·ç ï¼Ÿ
A: 
1. æ›´æ–° `invites.txt`
2. é‡æ–°è¿è¡Œ `node tools/generate-bulk.js`
3. é‡æ–°å¯¼å…¥ï¼š`wrangler kv:bulk put --namespace-id <ID> bulk.json`

### Q: å¦‚ä½•é‡ç½®å·²ä½¿ç”¨çš„é‚€è¯·ç ï¼Ÿ
A: é‡æ–°å¯¼å…¥ç›¸åŒçš„ hash é”®ï¼Œä½†å°† `used` è®¾ä¸º `false`

---

## ğŸ“ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# ç™»å½•
wrangler login

# æŸ¥çœ‹ KV å‘½åç©ºé—´
wrangler kv:namespace list

# ç”Ÿæˆé‚€è¯·ç æ–‡ä»¶
$env:INVITE_SALT="ä½ çš„ç›å€¼"
node tools/generate-bulk.js

# å¯¼å…¥é‚€è¯·ç 
wrangler kv:bulk put --namespace-id <ID> bulk.json

# éƒ¨ç½²
wrangler pages deploy . --project-name=stranger-things-test

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
wrangler pages deployment list --project-name=stranger-things-test
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥ï¼š
1. Cloudflare Dashboard ä¸­çš„é”™è¯¯æ—¥å¿—
2. Wrangler å‘½ä»¤çš„è¾“å‡ºä¿¡æ¯
3. æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

