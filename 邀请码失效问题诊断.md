# 邀请码失效问题诊断和修复

## 🔍 问题描述

刚生成的邀请码验证时显示"邀请码已失效，请重新验证"

## 🔧 可能的原因

### 1. INVITE_SALT 不一致（最可能）

**问题**：生成邀请码和验证邀请码时使用的 `INVITE_SALT` 不同

**检查方法**：
1. 确认 Cloudflare Pages 环境变量 `INVITE_SALT` 的值
2. 确认生成邀请码时使用的盐值
3. 两者必须完全一致

**修复方法**：
- 在 Cloudflare Dashboard 中检查 `INVITE_SALT` 环境变量
- 确保生成和验证使用相同的盐值

### 2. KV 写入延迟

**问题**：邀请码写入 KV 后，立即验证可能还没生效

**检查方法**：
- 生成邀请码后，等待 1-2 秒再验证

**修复方法**：
- 已添加写入验证，确保写入成功
- 如果仍然失败，可能是 KV 延迟问题

### 3. 本地存储未同步

**问题**：邀请码添加到 KV，但本地存储中没有

**检查方法**：
- 打开浏览器控制台（F12）
- 查看是否有错误信息
- 检查 localStorage 中是否有邀请码

**修复方法**：
- 已修复：生成邀请码后立即保存到本地存储
- 已添加调试日志

### 4. 哈希计算问题

**问题**：生成和验证时的哈希计算不一致

**检查方法**：
- 查看 API 日志中的哈希值
- 确认哈希计算逻辑一致

**修复方法**：
- 已添加调试日志
- 哈希计算逻辑已确认一致

---

## 🛠️ 已应用的修复

### 1. 改进错误提示
- ✅ 更详细的错误信息
- ✅ 区分网络错误和验证错误
- ✅ 提示用户如果是刚生成的邀请码，稍后重试

### 2. 改进本地存储
- ✅ 生成邀请码后立即保存到本地存储
- ✅ 添加保存验证
- ✅ 添加调试日志

### 3. 改进 API 验证
- ✅ 添加写入验证，确保 KV 写入成功
- ✅ 添加调试日志
- ✅ 改进错误处理

### 4. 改进本地验证
- ✅ 添加 Storage 对象检查
- ✅ 添加调试日志
- ✅ 改进错误提示

---

## 🧪 诊断步骤

### 步骤 1：检查环境变量

1. **访问 Cloudflare Dashboard**
   - https://dash.cloudflare.com
   - Workers & Pages → Pages → stranger-things-test → Settings

2. **检查环境变量**
   - `INVITE_SALT` 的值是什么？
   - 记录下这个值

3. **检查 KV 绑定**
   - `INVITE_CODES` 是否已绑定？
   - KV 命名空间 ID 是否正确？

### 步骤 2：测试生成和验证

1. **生成邀请码**
   - 使用管理员面板生成一个测试邀请码
   - 记录下生成的邀请码

2. **等待 2-3 秒**
   - 确保 KV 写入完成

3. **验证邀请码**
   - 在首页输入邀请码
   - 查看是否成功

### 步骤 3：检查浏览器控制台

1. **打开开发者工具**（F12）
2. **查看 Console 标签**
   - 是否有错误信息？
   - 是否有调试日志？

3. **查看 Network 标签**
   - 检查 `/api/add-invite` 请求
   - 检查 `/api/verify-invite` 请求
   - 查看响应内容

### 步骤 4：检查 KV 存储

如果可能，使用 Wrangler CLI 检查：

```bash
# 计算哈希（需要知道盐值和邀请码）
# 然后查询 KV
wrangler kv:key get --namespace-id <NAMESPACE_ID> <HASH>
```

---

## 🔧 快速修复方法

### 方法 1：重新生成邀请码

1. 生成新的邀请码
2. 等待 2-3 秒
3. 再次验证

### 方法 2：检查并修复环境变量

1. 确认 `INVITE_SALT` 配置正确
2. 如果修改了盐值，需要重新生成所有邀请码

### 方法 3：使用本地验证（临时）

如果 API 验证失败，系统会自动回退到本地验证：
- 确保邀请码已保存到本地存储
- 本地验证应该可以工作

---

## 📝 调试信息

### 生成邀请码时的日志

查看浏览器控制台，应该看到：
```
邀请码已保存到本地存储: [...]
```

### 验证邀请码时的日志

查看浏览器控制台，应该看到：
```
本地验证邀请码: { code: "...", inviteCodesCount: X, deviceId: "..." }
```

### API 日志

查看 Cloudflare Dashboard → Workers & Pages → Logs，应该看到：
```
添加邀请码: { code: "...", hash: "..." }
验证邀请码: { code: "...", hash: "..." }
```

---

## ⚠️ 重要提示

1. **INVITE_SALT 必须一致**
   - 生成和验证必须使用相同的盐值
   - 如果修改了盐值，所有旧邀请码都会失效

2. **KV 写入可能需要时间**
   - 虽然通常很快，但有时可能需要几秒钟
   - 建议生成后等待 2-3 秒再验证

3. **本地存储和 KV 同步**
   - 生成时同时写入 KV 和本地存储
   - 验证时优先使用 API（KV），失败时回退到本地存储

---

## 🎯 如果问题仍然存在

1. **检查 Cloudflare Dashboard 日志**
   - 查看是否有错误信息
   - 查看 API 请求和响应

2. **检查浏览器控制台**
   - 查看错误信息
   - 查看网络请求

3. **测试 API 端点**
   ```bash
   # 测试添加邀请码
   curl -X POST https://你的域名/api/add-invite \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer 你的管理员密码" \
     -d '{"codes":["TEST01"]}'
   
   # 测试验证邀请码
   curl -X POST https://你的域名/api/verify-invite \
     -H "Content-Type: application/json" \
     -d '{"code":"TEST01"}'
   ```

4. **联系支持**
   - 提供错误信息
   - 提供浏览器控制台截图
   - 提供 API 响应内容

---

**最后更新**：2025-01-XX

