# 邀请码失效问题诊断及修复

## 🔍 问题描述

**现象**：刚生成的邀请码立即失效，无法验证通过

**错误提示**：`邀请码不存在或已失效`

---

## 🎯 根本原因

### 问题 1：盐值不一致（最关键）

邀请码使用 SHA-256 哈希存储：`hash = SHA256(INVITE_SALT + code)`

如果生成时和验证时的 `INVITE_SALT` 不一致，哈希值就不同，导致无法在 KV 中找到。

### 问题 2：KV 写入延迟

Cloudflare KV 是最终一致性存储，写入后可能需要几秒钟才能在全球边缘节点同步。

### 问题 3：本地存储未同步

生成邀请码后保存到本地存储，但验证时从 API 读取 KV，如果 KV 还没同步，验证就会失败。

---

## ✅ 解决方案

### 方案 1：确保盐值一致（必须）

#### 步骤 1：生成统一的盐值
```powershell
.\生成随机盐值.ps1
```

#### 步骤 2：配置到 Cloudflare
1. 访问 Cloudflare Dashboard
2. 进入 Workers & Pages → stranger-things-test → Settings → Environment variables
3. 添加/更新：`INVITE_SALT = 你生成的盐值`
4. 点击 Save

#### 步骤 3：重新部署
```bash
npm run deploy
```

### 方案 2：优先使用本地验证（推荐）

修改 `js/invite-code.js` 第 161 行，优先使用本地验证：

```javascript
try {
    // 先尝试本地验证（刚生成的邀请码在本地存储中）
    const localResult = validateInviteCode(code);
    
    if (localResult.success) {
        Storage.setCurrentInviteCode(code);
        if (successMsg) successMsg.style.display = 'block';
        startTest();
        return;
    }
    
    // 本地验证失败，尝试 API 验证
    const apiResult = await validateInviteCodeWithAPI(code);
    if (apiResult.success) {
        Storage.setCurrentInviteCode(code);
        startTest();
    } else {
        showError(apiResult.message);
    }
}
```

---

## 🔧 调试步骤

### 1. 查看 Cloudflare 日志
1. Cloudflare Dashboard → Workers & Pages → stranger-things-test → Logs
2. 搜索 "添加邀请码" 和 "验证邀请码"
3. 对比哈希值是否一致

### 2. 测试 KV 读写
```javascript
// 浏览器控制台测试
fetch('/api/add-invite', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer 你的密码'
    },
    body: JSON.stringify({ codes: ['TEST01'] })
}).then(r => r.json()).then(console.log);

// 2秒后验证
setTimeout(() => {
    fetch('/api/verify-invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: 'TEST01' })
    }).then(r => r.json()).then(console.log);
}, 2000);
```

---

## 📋 完整修复清单

### 必须执行
- [ ] 1. 生成统一的盐值
- [ ] 2. 配置 INVITE_SALT 环境变量
- [ ] 3. 重新部署项目
- [ ] 4. 清空浏览器 localStorage
- [ ] 5. 重新生成邀请码测试

### 可选执行
- [ ] 6. 修改验证逻辑，优先本地验证
- [ ] 7. 添加重试机制

---

## 🎯 验证修复

1. 清空旧数据：`localStorage.clear()`
2. 登录管理员面板
3. 生成测试邀请码
4. 立即验证邀请码
5. 检查是否成功

**预期结果**：邀请码立即可用

---

## 🚨 常见错误

### 错误 1：邀请码不存在于 KV 中
**原因**：盐值不一致  
**解决**：检查并统一 INVITE_SALT

### 错误 2：KV 写入验证失败
**原因**：KV 未绑定  
**解决**：检查 KV namespace bindings

### 错误 3：网络错误
**原因**：API 请求失败  
**解决**：检查网络和 Functions 状态

---

## 🎉 总结

**核心问题**：盐值不一致导致哈希值不匹配

**解决方案**：
1. 生成统一的盐值
2. 配置到 Cloudflare
3. 重新部署
4. 优化验证逻辑

**预计修复时间**：5-10 分钟