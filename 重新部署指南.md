# 🚀 重新部署指南

## 📋 部署前检查清单

在部署之前，请确保：

- [x] ✅ 代码优化已完成（重试机制、数据一致性、批量更新）
- [x] ✅ 所有文件已保存
- [ ] ⚠️ 检查是否有未提交的更改
- [ ] ⚠️ 确认环境变量已配置（ADMIN_PASSWORD, INVITE_SALT）
- [ ] ⚠️ 确认 KV 命名空间已绑定

---

## 🎯 推荐部署方式（按优先级）

### 方式 1：通过 Git 推送自动部署 ⭐⭐⭐⭐⭐（最简单）

**优点**：自动触发，无需手动操作

**步骤**：

1. **检查当前状态**
   ```bash
   git status
   ```

2. **添加所有更改**
   ```bash
   git add .
   ```

3. **提交更改**
   ```bash
   git commit -m "优化：添加重试机制、数据一致性检查和批量更新支持"
   ```

4. **推送到 GitHub**
   ```bash
   git push origin main
   ```

5. **查看部署状态**
   - 访问：https://dash.cloudflare.com
   - Workers & Pages → stranger-things-test → Deployments
   - 查看最新的部署记录和日志

**预计时间**：2-5 分钟自动完成

---

### 方式 2：使用 Wrangler CLI 手动部署 ⭐⭐⭐⭐

**优点**：直接部署，立即生效

**步骤**：

1. **确保已登录 Cloudflare**
   ```bash
   wrangler login
   ```
   如果已登录，会显示你的账号信息

2. **检查登录状态**
   ```bash
   wrangler whoami
   ```

3. **执行部署**
   ```bash
   cd "c:\Users\26872\Desktop\心理网站编写\怪奇物语测试"
   wrangler pages deploy . --project-name=stranger-things-test
   ```

4. **查看部署结果**
   - 部署成功会显示部署 URL
   - 访问：https://stranger-things-test.pages.dev

**预计时间**：1-3 分钟

---

### 方式 3：使用部署脚本 ⭐⭐⭐

**优点**：交互式，包含多个选项

**步骤**：

1. **运行部署脚本**
   ```powershell
   cd "c:\Users\26872\Desktop\心理网站编写\怪奇物语测试"
   .\deploy.ps1
   ```

2. **选择选项**
   - 输入 `1` 选择"直接部署"
   - 脚本会自动检查环境并执行部署

**预计时间**：2-4 分钟

---

### 方式 4：通过 Cloudflare Dashboard ⭐⭐⭐⭐

**优点**：可视化操作，适合不熟悉命令行的用户

**步骤**：

1. **访问 Cloudflare Dashboard**
   - 打开：https://dash.cloudflare.com
   - 登录你的账号

2. **进入 Pages 项目**
   - Workers & Pages → Pages → stranger-things-test

3. **手动触发部署**
   - 点击 "Deployments" 标签页
   - 点击 "Retry deployment" 或 "Create deployment"
   - 选择分支：`main`
   - 点击 "Deploy"

4. **查看部署进度**
   - 在 Deployments 页面查看实时日志
   - 等待部署完成（通常 2-5 分钟）

**预计时间**：2-5 分钟

---

## 🔍 部署后验证

### 1. 检查网站可访问性

访问你的网站：
- **Pages URL**：https://stranger-things-test.pages.dev
- **自定义域名**：（如果已配置）

### 2. 测试新功能

#### 测试重试机制
1. 打开浏览器开发者工具（F12）
2. 完成一次测试
3. 查看控制台日志，应该看到：
   ```
   [updateInviteCodeUsage] 准备发送到API: code=..., usedCount=...
   [updateInviteCodeUsage] 邀请码使用记录已同步到服务器
   ```

#### 测试数据一致性
1. 模拟本地存储失败（在控制台执行）：
   ```javascript
   // 临时禁用 localStorage
   const originalSetItem = Storage.prototype.setItem;
   Storage.prototype.setItem = function() { throw new Error('Storage full'); };
   ```
2. 完成一次测试
3. 查看是否标记了数据不一致

### 3. 测试 API 端点

```bash
# 测试更新邀请码使用记录 API
curl -X POST https://stranger-things-test.pages.dev/api/update-invite-usage \
  -H "Content-Type: application/json" \
  -d '{
    "code": "TEST123",
    "usedCount": 1,
    "lastUsedAt": "2025-01-XXT00:00:00.000Z",
    "deviceId": "test-device"
  }'
```

### 4. 检查部署日志

在 Cloudflare Dashboard：
- Pages → stranger-things-test → Deployments
- 点击最新的部署记录
- 查看 Build Logs 和 Runtime Logs

---

## ⚠️ 常见问题

### 问题 1：部署失败 - 环境变量未配置

**错误信息**：
```
missing bindings: INVITE_CODES or INVITE_SALT
```

**解决方法**：
1. 进入 Cloudflare Dashboard
2. Pages → stranger-things-test → Settings
3. Environment variables → 添加：
   - `ADMIN_PASSWORD`: 你的管理员密码
   - `INVITE_SALT`: 你的随机盐值
4. KV namespaces → 绑定 `INVITE_CODES`

### 问题 2：部署失败 - KV 命名空间未绑定

**错误信息**：
```
KV namespace not found
```

**解决方法**：
1. 在 Cloudflare Dashboard 创建 KV 命名空间
2. 在 Pages 项目设置中绑定命名空间
3. 重新部署

### 问题 3：Wrangler 未登录

**错误信息**：
```
You are not authenticated
```

**解决方法**：
```bash
wrangler login
```
然后在浏览器中完成 OAuth 登录

### 问题 4：Git 推送后未自动部署

**可能原因**：
- GitHub 仓库未连接到 Cloudflare Pages
- 分支名称不匹配（应该是 `main`）

**解决方法**：
1. 检查 Cloudflare Dashboard → Pages → Settings → Builds & deployments
2. 确认生产分支是 `main`
3. 检查 Git 连接状态

---

## 📊 本次优化内容

本次部署包含以下优化：

1. ✅ **指数退避重试机制**
   - API 调用失败时自动重试（最多 3 次）
   - 智能判断哪些错误应该重试

2. ✅ **数据同步一致性处理**
   - 本地保存失败但 API 成功时的标记和修复
   - 失败时的自动回滚

3. ✅ **批量更新支持**
   - 为将来扩展准备的批量更新功能

---

## 🎉 部署成功标志

部署成功后，你应该看到：

1. ✅ Cloudflare Dashboard 显示部署成功（绿色 ✓）
2. ✅ 网站可以正常访问
3. ✅ API 端点正常工作
4. ✅ 控制台日志显示新的优化功能

---

## 📞 需要帮助？

如果遇到问题：

1. **查看部署日志**：Cloudflare Dashboard → Deployments → 最新部署 → Logs
2. **检查浏览器控制台**：F12 → Console
3. **查看网络请求**：F12 → Network → 检查 API 请求状态
4. **参考文档**：
   - `优化实现说明.md` - 优化功能详细说明
   - `手动部署方法.md` - 其他部署方式
   - `GitHub连接说明.md` - Git 相关说明

---

**最后更新**：2025-01-XX  
**部署版本**：v2.0（包含优化功能）  
**状态**：✅ 准备部署
