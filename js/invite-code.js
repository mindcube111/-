// é‚€è¯·ç éªŒè¯é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    // ç­‰å¾…ä¾èµ–åŠ è½½å®Œæˆ
    if (typeof Storage === 'undefined' || typeof DeviceManager === 'undefined' || typeof CONFIG === 'undefined') {
        console.error('é‚€è¯·ç éªŒè¯éœ€è¦ä¾èµ– Storage, DeviceManager, CONFIG');
        return;
    }

    // è·å–DOMå…ƒç´ ï¼ˆé€‚é… index.html çš„ç»“æ„ï¼‰
    const inviteCodeInput = document.getElementById('invite-code-input');
    const submitBtn = document.getElementById('invite-code-submit');
    const errorMsg = document.getElementById('invite-code-error');
    const successMsg = document.getElementById('invite-code-success');
    const inviteCodeSection = document.getElementById('invite-code-section');

    // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œè¯´æ˜ä¸åœ¨ index.html é¡µé¢ï¼Œç›´æ¥è¿”å›
    if (!inviteCodeInput || !submitBtn || !errorMsg) {
        if (typeof Logger !== 'undefined') Logger.log('é‚€è¯·ç å…ƒç´ ä¸å­˜åœ¨ï¼Œå¯èƒ½ä¸åœ¨ index.html é¡µé¢');
        return;
    }

    // ç¡®ä¿é‚€è¯·ç è¾“å…¥åŒºåŸŸé»˜è®¤æ˜¾ç¤º
    if (inviteCodeSection) {
        inviteCodeSection.style.display = 'block';
    }
    // ç¡®ä¿æˆåŠŸæ¶ˆæ¯é»˜è®¤éšè—
    if (successMsg) {
        successMsg.style.display = 'none';
    }
    // ç¡®ä¿é”™è¯¯æ¶ˆæ¯é»˜è®¤éšè—
    if (errorMsg) {
        errorMsg.textContent = '';
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æœ‰æ•ˆçš„é‚€è¯·ç ï¼ˆä»…æ£€æŸ¥ï¼Œä¸è‡ªåŠ¨è·³è½¬ï¼‰
    try {
        const currentCode = Storage.getCurrentInviteCode();
        if (currentCode) {
            const inviteCodes = Storage.getInviteCodes();
            const deviceId = DeviceManager.getDeviceId();
            const invite = inviteCodes.find(item => 
                item.code === currentCode && 
                item.deviceId === deviceId &&
                item.usedCount < CONFIG.MAX_USE_COUNT
            );
            
            if (!invite) {
                // é‚€è¯·ç æ— æ•ˆï¼Œæ¸…é™¤å®ƒ
                Storage.remove(CONFIG.STORAGE_KEYS.CURRENT_INVITE_CODE);
            }
            // ä¸è‡ªåŠ¨è·³è½¬ï¼Œå§‹ç»ˆæ˜¾ç¤ºè¾“å…¥ç•Œé¢
        }
    } catch (error) {
        console.error('æ£€æŸ¥é‚€è¯·ç æ—¶å‡ºé”™:', error);
        // å‡ºé”™æ—¶ç¡®ä¿é‚€è¯·ç è¾“å…¥åŒºåŸŸæ˜¾ç¤º
        if (inviteCodeSection) inviteCodeSection.style.display = 'block';
    }
    
    // ç¡®ä¿æµ‹è¯•é¡µé¢é»˜è®¤éšè—
    if (typeof window.ensureIntroSectionVisible === 'function') {
        window.ensureIntroSectionVisible();
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œDOM
        setTimeout(() => {
            const introSection = document.getElementById('intro-section');
            const progressSection = document.getElementById('progress-section');
            const answerCardSection = document.getElementById('answer-card-section');
            const questionSection = document.getElementById('question-section');
            
            if (introSection) introSection.classList.remove('hidden');
            if (progressSection) progressSection.classList.add('hidden');
            if (answerCardSection) answerCardSection.classList.add('hidden');
            if (questionSection) questionSection.classList.add('hidden');
        }, 100);
    }

    // ç¡®ä¿è¾“å…¥æ¡†å¯ç¼–è¾‘
    inviteCodeInput.removeAttribute('readonly');
    inviteCodeInput.removeAttribute('disabled');
    inviteCodeInput.setAttribute('autocomplete', 'off');
    
    // ç¡®ä¿è¾“å…¥æ¡†æ ·å¼æ­£ç¡®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    inviteCodeInput.style.pointerEvents = 'auto !important';
    inviteCodeInput.style.cursor = 'text';
    inviteCodeInput.style.zIndex = '9999';
    inviteCodeInput.style.position = 'relative';
    inviteCodeInput.style.opacity = '1';
    inviteCodeInput.tabIndex = 0;
    
    // ç¡®ä¿è¾“å…¥æ¡†å®¹å™¨ä¹Ÿå¯äº¤äº’
    if (inviteCodeSection) {
        inviteCodeSection.style.pointerEvents = 'auto';
        inviteCodeSection.style.zIndex = '9999';
        inviteCodeSection.style.position = 'relative';
    }
    
    const inputWrapper = inviteCodeInput.parentElement;
    if (inputWrapper) {
        inputWrapper.style.pointerEvents = 'auto';
        inputWrapper.style.zIndex = '9999';
        inputWrapper.style.position = 'relative';
    }
    
    // è°ƒè¯•ä¿¡æ¯
    setTimeout(() => {
        const computedStyle = window.getComputedStyle(inviteCodeInput);
        if (typeof Logger !== 'undefined') {
            Logger.log('é‚€è¯·ç è¾“å…¥æ¡†çŠ¶æ€:', {
                disabled: inviteCodeInput.disabled,
                readonly: inviteCodeInput.readOnly,
                display: computedStyle.display,
                pointerEvents: computedStyle.pointerEvents,
                zIndex: computedStyle.zIndex,
                position: computedStyle.position,
                opacity: computedStyle.opacity
            });
        }
        
        // æµ‹è¯•æ˜¯å¦å¯ä»¥èšç„¦
        try {
            inviteCodeInput.focus();
            if (typeof Logger !== 'undefined') Logger.log('è¾“å…¥æ¡†å·²æˆåŠŸèšç„¦');
        } catch (e) {
            console.error('æ— æ³•èšç„¦è¾“å…¥æ¡†:', e);
        }
    }, 100);
    
    // è‡ªåŠ¨è½¬å¤§å†™å¹¶è¿‡æ»¤éæ³•å­—ç¬¦
    inviteCodeInput.addEventListener('input', function(e) {
        if (typeof Logger !== 'undefined') Logger.log('è¾“å…¥äº‹ä»¶è§¦å‘:', this.value);
        const originalValue = this.value;
        this.value = originalValue.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (errorMsg) errorMsg.textContent = '';
        inviteCodeInput.classList.remove('error');
    });
    
    // ç›‘å¬ç„¦ç‚¹äº‹ä»¶
    inviteCodeInput.addEventListener('focus', function() {
        if (typeof Logger !== 'undefined') Logger.log('é‚€è¯·ç è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹');
        this.style.borderColor = 'var(--accent)';
    });
    
    inviteCodeInput.addEventListener('blur', function() {
        this.style.borderColor = '';
    });
    
    // ç›‘å¬ç‚¹å‡»äº‹ä»¶
    inviteCodeInput.addEventListener('click', function() {
        if (typeof Logger !== 'undefined') Logger.log('é‚€è¯·ç è¾“å…¥æ¡†è¢«ç‚¹å‡»');
        this.focus();
    });

    // å›è½¦æäº¤
    inviteCodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitBtn.click();
        }
    });

    // æäº¤éªŒè¯
    submitBtn.addEventListener('click', async function() {
        const code = inviteCodeInput.value.trim();
        
        if (!code) {
            showError('è¯·è¾“å…¥é‚€è¯·ç ');
            return;
        }

        if (code.length !== CONFIG.INVITE_CODE_LENGTH) {
            showError('é‚€è¯·ç å¿…é¡»ä¸º6ä½');
            return;
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'éªŒè¯ä¸­...';

        try {
            // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°éªŒè¯ï¼ˆåˆšç”Ÿæˆçš„é‚€è¯·ç åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼‰
            console.log('å¼€å§‹éªŒè¯é‚€è¯·ç :', code);
            const localResult = await validateInviteCode(code);
            
            if (localResult.success) {
                // æœ¬åœ°éªŒè¯æˆåŠŸï¼Œç›´æ¥ä½¿ç”¨
                console.log('æœ¬åœ°éªŒè¯æˆåŠŸ');
                Storage.setCurrentInviteCode(code);
                if (errorMsg) errorMsg.textContent = '';
                if (successMsg) {
                    successMsg.textContent = localResult.message || 'é‚€è¯·ç éªŒè¯æˆåŠŸï¼';
                    successMsg.style.display = 'block';
                }
                inviteCodeInput.value = '';
                startTest();
                return;
            }
            
            // æœ¬åœ°éªŒè¯å¤±è´¥ï¼Œå°è¯• API éªŒè¯ï¼ˆå¯èƒ½æ˜¯å…¶ä»–è®¾å¤‡ç”Ÿæˆçš„é‚€è¯·ç ï¼‰
            console.log('æœ¬åœ°éªŒè¯å¤±è´¥ï¼Œå°è¯• API éªŒè¯');
            const apiResult = await validateInviteCodeWithAPI(code);
            
            if (apiResult.success) {
                // API éªŒè¯æˆåŠŸ
                console.log('API éªŒè¯æˆåŠŸ');
                Storage.setCurrentInviteCode(code);
                if (errorMsg) errorMsg.textContent = '';
                if (successMsg) {
                    const remaining = apiResult.remaining !== undefined ? apiResult.remaining : (CONFIG.MAX_USE_COUNT - (apiResult.usedCount || 0));
                    successMsg.textContent = `é‚€è¯·ç éªŒè¯æˆåŠŸï¼å‰©ä½™å¯ç”¨æ¬¡æ•°ï¼š${remaining}æ¬¡`;
                    successMsg.style.display = 'block';
                }
                inviteCodeInput.value = '';
                startTest();
            } else {
                // API éªŒè¯ä¹Ÿå¤±è´¥
                showError(apiResult.message);
            }
        } catch (error) {
            console.error('éªŒè¯é‚€è¯·ç æ—¶å‡ºé”™:', error);
            // API è¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            } else {
                showError('éªŒè¯å¤±è´¥ï¼š' + error.message);
            }
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    /**
     * é€šè¿‡ API éªŒè¯é‚€è¯·ç ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
     * @param {string} code
     * @returns {Promise<Object>}
     */
    async function validateInviteCodeWithAPI(code) {
        try {
            const response = await fetch('/api/verify-invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            });

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œä»¥ä¾¿è°ƒè¯•
            const responseText = await response.text();
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('å“åº”è§£æå¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText);
                throw new Error('å“åº”æ ¼å¼é”™è¯¯');
            }
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('API éªŒè¯å“åº”:', {
                status: response.status,
                ok: response.ok,
                statusText: response.statusText,
                data: data,
                responseText: responseText
            });

            if (response.ok && data && data.ok === true) {
                // API éªŒè¯æˆåŠŸï¼ŒåŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                try {
                    const inviteCodes = Storage.getInviteCodes() || [];
                    const deviceId = DeviceManager.getDeviceId();
                    let invite = inviteCodes.find(item => item && item.code === code);
                    
                    const now = new Date().toISOString();
                    if (!invite) {
                        // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è®°å½•
                        invite = {
                            code: code,
                            deviceId: deviceId,
                            usedCount: data.usedCount || 1,
                            createdAt: new Date().toISOString(),
                            lastUsedAt: now,
                            boundAt: now,
                            disabled: false,
                            usageHistory: [{
                                deviceId: deviceId,
                                usedAt: now,
                                userAgent: navigator.userAgent || 'unknown',
                                ip: 'unknown'
                            }]
                        };
                        inviteCodes.push(invite);
                    } else {
                        // æ›´æ–°ç°æœ‰è®°å½•ï¼ˆAPIéªŒè¯æ—¶ä¸å¢åŠ ä½¿ç”¨æ¬¡æ•°ï¼‰
                        // ä½¿ç”¨æ¬¡æ•°åœ¨æµ‹è¯•å®Œæˆæ—¶é€šè¿‡ update-invite-usage API å¢åŠ 
                        if (data.usedCount !== undefined) {
                            invite.usedCount = data.usedCount; // ä½¿ç”¨APIè¿”å›çš„å€¼ï¼Œä¸å¢åŠ 
                        }
                        invite.lastUsedAt = now;
                        if (!invite.deviceId) {
                            invite.deviceId = deviceId;
                            invite.boundAt = now;
                        }
                        // åˆå§‹åŒ–ä½¿ç”¨è®°å½•æ•°ç»„
                        if (!invite.usageHistory) {
                            invite.usageHistory = [];
                        }
                        // æ·»åŠ éªŒè¯è®°å½•ï¼ˆæ ‡è®°ä¸ºæœªå®Œæˆæµ‹è¯•ï¼‰
                        invite.usageHistory.push({
                            deviceId: deviceId,
                            usedAt: now,
                            userAgent: navigator.userAgent || 'unknown',
                            ip: 'unknown',
                            testCompleted: false // æ ‡è®°ä¸ºéªŒè¯ä½†æœªå®Œæˆæµ‹è¯•
                        });
                    }
                    
                    Storage.setInviteCodes(inviteCodes);
                    console.log('é‚€è¯·ç å·²åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨:', invite);
                } catch (syncError) {
                    console.error('åŒæ­¥é‚€è¯·ç åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', syncError);
                    // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿç»§ç»­ï¼Œå› ä¸º API éªŒè¯å·²ç»æˆåŠŸ
                }
                
                return {
                    success: true,
                    message: 'éªŒè¯æˆåŠŸ',
                    usedCount: data.usedCount,
                    remaining: data.remaining
                };
            } else {
                // æ ¹æ® API è¿”å›çš„é”™è¯¯ä¿¡æ¯æä¾›å‹å¥½çš„æç¤º
                let message = 'é‚€è¯·ç éªŒè¯å¤±è´¥';
                if (data.message === 'invalid') {
                    message = 'é‚€è¯·ç ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ';
                } else if (data.message === 'used') {
                    message = 'é‚€è¯·ç ä½¿ç”¨æ¬¡æ•°å·²ç”¨å°½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è·å–æ–°é‚€è¯·ç ';
                } else if (data.message === 'device_mismatch') {
                    message = 'è¯¥é‚€è¯·ç å·²ç»‘å®šå…¶ä»–è®¾å¤‡ï¼Œè¯·åœ¨é¦–æ¬¡ä½¿ç”¨çš„è®¾å¤‡ä¸Šæ“ä½œ';
                } else if (data.message) {
                    message = data.message;
                }
                return {
                    success: false,
                    message: message,
                    debug: data.debug
                };
            }
        } catch (error) {
            // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ä»¥ä¾¿å›é€€åˆ°æœ¬åœ°éªŒè¯
            console.error('API éªŒè¯è¯·æ±‚å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * éªŒè¯é‚€è¯·ç ï¼ˆæœ¬åœ°éªŒè¯ï¼Œç”¨äºå¼€å‘ç¯å¢ƒæˆ– API å¤±è´¥æ—¶çš„å›é€€ï¼‰
     * @param {string} code
     * @returns {Promise<Object>}
     */
    async function validateInviteCode(code) {
        try {
            // ç¡®ä¿ Storage å¯¹è±¡å·²åŠ è½½
            if (typeof Storage === 'undefined') {
                return {
                    success: false,
                    message: 'ç³»ç»Ÿé”™è¯¯ï¼šStorage æœªå®šä¹‰'
                };
            }
            
            const inviteCodes = Storage.getInviteCodes();
            const deviceId = DeviceManager.getDeviceId();
            
            // è°ƒè¯•ä¿¡æ¯
            if (typeof Logger !== 'undefined') {
                Logger.log('æœ¬åœ°éªŒè¯é‚€è¯·ç :', {
                    code: code,
                    inviteCodesCount: inviteCodes ? inviteCodes.length : 0,
                    deviceId: deviceId
                });
            }

            // ç¡®ä¿ inviteCodes æ˜¯æ•°ç»„
            if (!Array.isArray(inviteCodes)) {
                console.error('é‚€è¯·ç åˆ—è¡¨æ ¼å¼é”™è¯¯:', inviteCodes);
                return {
                    success: false,
                    message: 'ç³»ç»Ÿé”™è¯¯ï¼šé‚€è¯·ç æ•°æ®æ ¼å¼å¼‚å¸¸'
                };
            }

            // æŸ¥æ‰¾é‚€è¯·ç 
            const invite = inviteCodes.find(item => item && item.code === code);

            if (!invite) {
                return {
                    success: false,
                    message: 'é‚€è¯·ç ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ'
                };
            }

            // ç¡®ä¿ usedCount æ˜¯æ•°å­—
            const currentUsedCount = parseInt(invite.usedCount) || 0;
            
            // è°ƒè¯•ä¿¡æ¯
            if (typeof Logger !== 'undefined') {
                Logger.log('éªŒè¯é‚€è¯·ç :', {
                    code: code,
                    currentUsedCount: currentUsedCount,
                    maxUseCount: CONFIG.MAX_USE_COUNT,
                    deviceId: invite.deviceId,
                    currentDeviceId: deviceId
                });
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç¦ç”¨
            if (invite.disabled === true) {
                return {
                    success: false,
                    message: 'è¯¥é‚€è¯·ç å·²è¢«ç®¡ç†å‘˜ç¦ç”¨'
                };
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šè®¾å¤‡
            if (invite.deviceId && invite.deviceId !== deviceId) {
                return {
                    success: false,
                    message: 'è¯¥é‚€è¯·ç å·²ç»‘å®šå…¶ä»–è®¾å¤‡ï¼Œè¯·åœ¨é¦–æ¬¡ä½¿ç”¨çš„è®¾å¤‡ä¸Šæ“ä½œ'
                };
            }

            // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
            if (currentUsedCount >= CONFIG.MAX_USE_COUNT) {
                return {
                    success: false,
                    message: `é‚€è¯·ç ä½¿ç”¨æ¬¡æ•°å·²ç”¨å°½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è·å–æ–°é‚€è¯·ç `
                };
            }

            // æ›´æ–°é‚€è¯·ç ä¿¡æ¯
            const now = new Date().toISOString();
            if (!invite.deviceId) {
                invite.deviceId = deviceId;
                invite.boundAt = now; // è®°å½•ç»‘å®šæ—¶é—´
            }
            
            // åˆå§‹åŒ–ä½¿ç”¨è®°å½•æ•°ç»„
            if (!invite.usageHistory) {
                invite.usageHistory = [];
            }
            
            // éªŒè¯æ—¶ä¸å¢åŠ ä½¿ç”¨æ¬¡æ•°ï¼Œåªæ·»åŠ éªŒè¯è®°å½•ï¼ˆæ ‡è®°ä¸ºæœªå®Œæˆæµ‹è¯•ï¼‰
            const usageRecord = {
                deviceId: deviceId,
                usedAt: now,
                userAgent: navigator.userAgent || 'unknown',
                ip: 'unknown', // å‰ç«¯æ— æ³•è·å–çœŸå®IPï¼Œéœ€è¦åç«¯è®°å½•
                testCompleted: false // æ ‡è®°ä¸ºéªŒè¯ä½†æœªå®Œæˆæµ‹è¯•
            };
            invite.usageHistory.push(usageRecord);
            
            // éªŒè¯æ—¶ä¸å¢åŠ ä½¿ç”¨æ¬¡æ•°ï¼Œä½¿ç”¨æ¬¡æ•°åœ¨æµ‹è¯•å®Œæˆæ—¶å¢åŠ 
            // invite.usedCount = currentUsedCount + 1; // æ³¨é‡Šæ‰ï¼Œæµ‹è¯•å®Œæˆæ—¶å†å¢åŠ 
            invite.lastUsedAt = now;

            // ä¿å­˜æ›´æ–°åˆ°æœ¬åœ°
            const saved = Storage.setInviteCodes(inviteCodes);
            if (!saved) {
                console.error('ä¿å­˜é‚€è¯·ç å¤±è´¥');
                return {
                    success: false,
                    message: 'ä¿å­˜é‚€è¯·ç ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•'
                };
            }
            
            // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
            if (typeof SyncStorage !== 'undefined') {
                try {
                    await SyncStorage.set(CONFIG.STORAGE_KEYS.INVITE_CODES, inviteCodes);
                    if (typeof Logger !== 'undefined') Logger.log('é‚€è¯·ç ä½¿ç”¨æƒ…å†µå·²åŒæ­¥åˆ°äº‘ç«¯');
                } catch (error) {
                    console.error('åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:', error);
                    // åŒæ­¥å¤±è´¥ä¸å½±å“æœ¬åœ°ä½¿ç”¨
                }
            }

            // éªŒè¯æ—¶ä¸å¢åŠ ä½¿ç”¨æ¬¡æ•°ï¼Œæ‰€ä»¥ remaining åŸºäºå½“å‰ä½¿ç”¨æ¬¡æ•°
            const remaining = CONFIG.MAX_USE_COUNT - currentUsedCount;
            if (typeof Logger !== 'undefined') Logger.log('é‚€è¯·ç éªŒè¯æˆåŠŸï¼Œå½“å‰ä½¿ç”¨æ¬¡æ•°:', currentUsedCount, 'å‰©ä½™æ¬¡æ•°:', remaining);

            return {
                success: true,
                message: `é‚€è¯·ç éªŒè¯æˆåŠŸï¼å‰©ä½™å¯ç”¨æ¬¡æ•°ï¼š${remaining}æ¬¡`,
                usedCount: currentUsedCount,
                remaining: remaining
            };
        } catch (error) {
            console.error('éªŒè¯é‚€è¯·ç æ—¶å‡ºé”™:', error);
            return {
                success: false,
                message: 'éªŒè¯è¿‡ç¨‹ä¸­å‡ºé”™ï¼š' + error.message
            };
        }
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
     * @param {string} message
     */
    function showError(message) {
        if (errorMsg) {
            errorMsg.textContent = message;
        }
        if (inviteCodeInput) {
            inviteCodeInput.classList.add('error');
            setTimeout(() => {
                inviteCodeInput.classList.remove('error');
            }, 500);
        }
        if (successMsg) {
            successMsg.style.display = 'none';
        }
    }

    /**
     * å¼€å§‹æµ‹è¯•
     */
    function startTest() {
        // éªŒè¯é‚€è¯·ç æ˜¯å¦æœ‰æ•ˆ
        const currentCode = Storage.getCurrentInviteCode();
        if (!currentCode) {
            showError('è¯·å…ˆéªŒè¯é‚€è¯·ç ');
            return;
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„é‚€è¯·ç ï¼ˆå¦‚æœ API éªŒè¯æˆåŠŸï¼Œåº”è¯¥å·²ç»åŒæ­¥ï¼‰
        const inviteCodes = Storage.getInviteCodes() || [];
        const deviceId = DeviceManager.getDeviceId();
        let invite = inviteCodes.find(item => 
            item && item.code === currentCode
        );

        // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ï¼Œä½† API éªŒè¯å·²ç»æˆåŠŸï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶è®°å½•
        if (!invite) {
            console.warn('æœ¬åœ°å­˜å‚¨ä¸­æœªæ‰¾åˆ°é‚€è¯·ç ï¼Œä½† API éªŒè¯å·²æˆåŠŸï¼Œåˆ›å»ºä¸´æ—¶è®°å½•');
            invite = {
                code: currentCode,
                deviceId: deviceId,
                usedCount: 1, // API éªŒè¯æˆåŠŸåï¼Œä½¿ç”¨æ¬¡æ•°åº”è¯¥æ˜¯ 1
                createdAt: new Date().toISOString(),
                lastUsedAt: new Date().toISOString()
            };
            inviteCodes.push(invite);
            Storage.setInviteCodes(inviteCodes);
        }

        // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°ï¼ˆå…è®¸ç»§ç»­ï¼Œå› ä¸º API å·²ç»éªŒè¯è¿‡ï¼‰
        if (invite.usedCount >= CONFIG.MAX_USE_COUNT) {
            showError('é‚€è¯·ç ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™');
            return;
        }

        // éšè—é‚€è¯·ç è¾“å…¥åŒºåŸŸ
        if (inviteCodeSection) {
            inviteCodeSection.style.display = 'none';
        }
        
        // ç›´æ¥è°ƒç”¨å…¨å±€çš„å¼€å§‹æµ‹è¯•å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof window.startTestAfterInviteCode === 'function') {
            window.startTestAfterInviteCode();
        } else {
            // å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œè§¦å‘è‡ªå®šä¹‰äº‹ä»¶è®© script.js å¤„ç†
            const startTestEvent = new CustomEvent('inviteCodeVerified', {
                detail: { code: currentCode }
            });
            document.dispatchEvent(startTestEvent);
        }
    }
});









