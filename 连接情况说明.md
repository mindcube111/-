# 管理员后台和邀请码验证连接情况说明

## ✅ 已修复：邀请码验证已连接 API

**修改文件**：`js/invite-code.js`

**修改内容**：
- 邀请码验证现在优先调用 Cloudflare API (`/api/verify-invite`)
- 如果 API 调用失败，会回退到本地 localStorage 验证（用于开发环境）
- 支持生产环境和开发环境的无缝切换

**工作流程**：
1. 用户输入邀请码
2. 前端调用 `/api/verify-invite` API
3. API 验证 KV 中的邀请码（哈希存储）
4. 验证成功后，保存到 localStorage 并开始测试
5. 如果 API 失败，回退到本地验证（开发模式）

---

## ⚠️ 管理员后台：使用本地存储（开发用途）

**当前状态**：管理员后台使用 localStorage 存储和管理邀请码

**说明**：
- 管理员后台主要用于**本地开发**和**测试**
- 在生产环境中，邀请码应该通过以下方式导入：
  1. 创建 `invites.txt` 文件
  2. 运行 `node tools/generate-bulk.js` 生成 `bulk.json`
  3. 使用 `wrangler kv:bulk put` 导入到 Cloudflare KV

**管理员后台功能**：
- ✅ 生成邀请码（存储到 localStorage）
- ✅ 查看邀请码列表
- ✅ 统计使用情况
- ✅ 删除邀请码

**注意**：管理员后台生成的邀请码**不会自动同步到 Cloudflare KV**。生产环境中的邀请码需要通过 KV 导入。

---

## 📋 系统架构

### 生产环境（Cloudflare Pages）

```
用户输入邀请码
    ↓
前端调用 /api/verify-invite
    ↓
Cloudflare Functions 验证 KV 中的邀请码
    ↓
验证成功 → 开始测试
```

### 开发环境（本地）

```
用户输入邀请码
    ↓
尝试调用 /api/verify-invite（可能失败）
    ↓
回退到 localStorage 验证
    ↓
验证成功 → 开始测试
```

---

## 🔧 如何确保连接正常

### 1. 检查 API 端点

确保 Cloudflare Pages 项目已配置：
- ✅ 环境变量：`INVITE_SALT`
- ✅ KV 绑定：`INVITE_CODES`
- ✅ Functions 文件：`functions/api/verify-invite.js`

### 2. 导入邀请码到 KV

```bash
# 1. 创建 invites.txt（每行一个邀请码）
# 2. 生成 bulk.json
$env:INVITE_SALT="你的盐值"
node tools/generate-bulk.js

# 3. 导入到 KV
wrangler kv:bulk put --namespace-id <NAMESPACE_ID> bulk.json
```

### 3. 测试连接

```bash
# 测试 API
curl -X POST https://你的域名/api/verify-invite \
  -H "Content-Type: application/json" \
  -d '{"code":"ABC123"}'
```

---

## 🎯 总结

| 功能 | 存储位置 | 连接状态 |
|------|---------|---------|
| 邀请码验证（生产） | Cloudflare KV | ✅ 已连接 API |
| 邀请码验证（开发） | localStorage | ✅ 回退机制 |
| 管理员后台 | localStorage | ⚠️ 仅开发用途 |
| 邀请码生成（生产） | Cloudflare KV | ✅ 通过工具导入 |

---

## 📝 建议

1. **生产环境**：使用 Cloudflare KV 存储邀请码，通过 API 验证
2. **开发环境**：可以使用管理员后台生成邀请码到 localStorage
3. **部署前**：确保邀请码已导入到 KV，并测试 API 连接

---

**最后更新**：2025-01-XX


